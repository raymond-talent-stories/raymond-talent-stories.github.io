<script>
  function* gen(taskQueue) {
    while (taskQueue.length > 0) {
      const nextTask = taskQueue.shift()
      nextTask()
      yield taskQueue
    }
  }

  function timeSlice(taskQueue, duration) {
    return new Promise((resolve) => {
      const startTime = performance.now()
      const g = gen(taskQueue)
      let res
      let overtime = false
      do {
        res = g.next()
        overtime = performance.now() - startTime > duration
        if (res.done || overtime) {
          resolve(taskQueue)
        }
      } while (res.done !== true && !overtime)
    })
  }
  // 创建100万次循环任务
  const tasks = Array.from({ length: 100000 }).map(t => () => { console.log(performance.now()) })

  function run(tasks) {
    timeSlice(tasks, 15).then((restTasks) => restTasks.length > 0 && run(restTasks))
  }

  run(tasks)
</script>